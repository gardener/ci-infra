{
  $schema: 'https://docs.renovatebot.com/renovate-schema.json',
  extends: [
    'config:recommended',
    'github>gardener/ci-infra//config/renovate/automerge-with-tide.json5',
  ],
  labels: [
    'kind/enhancement',
  ],
  postUpdateOptions: [
    'gomodTidy',
  ],
  customManagers: [
    {
      customType: 'regex',
      fileMatch: [
        'config/prow/cluster/.+/helm/generate-.+-deployments.sh$',
      ],
      matchStrings: [
        'helm repo add .+ (?<registryUrl>.+?)\\s(.|\\n)*helm template -n .+ .+ .+\\/(?<depName>.+?) --version "(?<currentValue>.*)"\\s',
      ],
      datasourceTemplate: 'helm',
    },
    {
      customType: 'regex',
      fileMatch: [
        'Makefile$',
        '\\.mk$',
        '\\.sh$',
      ],
      matchStrings: [
        '# renovate: datasource=(?<datasource>[a-z-.]+?) depName=(?<depName>[^\\s]+?)(?: (lookupName|packageName)=(?<packageName>[^\\s]+?))?(?: versioning=(?<versioning>[^\\s]+?))?(?: extractVersion=(?<extractVersion>[^\\s]+?))?(?: registryUrl=(?<registryUrl>[^\\s]+?))?\\s.+?_(VERSION|version) *[?:]?= *"?(?<currentValue>.+?)"?\\s',
      ],
    },
    {
      customType: 'regex',
      fileMatch: [
        '^config/jobs/.+\\.yaml$',
      ],
      matchStrings: [
        'image(: |=)(?<depName>.*?):(?<currentValue>.*?)\\s',
      ],
      datasourceTemplate: 'docker',
    },
    {
      customType: 'regex',
      fileMatch: [
        '^config/images/images\\.yaml$',
      ],
      matchStrings: [
        '\\s+source:\\s+(?<depName>.+?)\\n\\s+destination:\\s+.*\\n\\s+tags:\\n(\\s+-\\s+v?[0-9][0-9a-zA-Z\\-\\.]*\\n)*\\s+-\\s+(?<currentValue>.+?)\\n',
      ],
      datasourceTemplate: 'docker',
    },
  ],
  separateMinorPatch: true,
  packageRules: [
    {
      groupName: 'update: prow apps',
      matchDatasources: [
        'github-releases',
        'helm',
      ],
      postUpgradeTasks: {
        commands: [
          'install-tool helm v3.15.2',
          'make generate-prow-deployments',
        ],
        executionMode: 'branch',
      },
      matchPackageNames: [
        '/athens-proxy/',
        '/ingress-nginx/',
        '/oauth2-proxy/',
        '/renovate/',
        '/prometheus-operator/kube-prometheus/',
      ],
    },
    {
      groupName: 'auto-update: renovate',
      matchDatasources: [
        'docker',
        'helm',
      ],
      postUpgradeTasks: {
        commands: [
          'install-tool helm v3.15.2',
          'make generate-prow-deployments',
        ],
        executionMode: 'branch',
      },
      automerge: true,
      schedule: [
        'after 08:30 and before 15:30 every weekday',
      ],
      matchPackageNames: [
        '/^renovate$/',
        '/^ghcr\\.io/renovatebot/renovate$/',
      ],
    },
    {
      matchDatasources: [
        'go',
      ],
      extends: [
        'schedule:monthly',
      ],
      matchPackageNames: [
        '/sigs\\.k8s\\.io/prow/',
      ],
    },
    {
      matchDatasources: [
        'go',
      ],
      enabled: false,
      matchPackageNames: [
        '/k8s\\.io/(api|apimachinery|client-go)/',
        '/sigs\\.k8s\\.io/controller-runtime/',
      ],
    },
    {
      matchManagers: [
        'gomod',
      ],
      matchUpdateTypes: [
        'patch',
      ],
      enabled: false,
      matchPackageNames: [
        '/go/',
      ],
    },
    {
      matchDatasources: [
        'docker',
      ],
      matchUpdateTypes: [
        'major',
        'minor',
      ],
      enabled: false,
      matchPackageNames: [
        '/grafana/grafana/',
      ],
    },
    {
      matchDatasources: [
        'docker',
      ],
      matchUpdateTypes: [
        'major',
        'minor',
        'patch',
      ],
      matchFileNames: [
        'config/images/images.yaml',
      ],
      enabled: false,
      matchPackageNames: [
        '/coredns/coredns/',
        '/calico/node/',
        '/calico/cni/',
        '/calico/typha/',
        '/calico/kube-controllers/',
        '/calico/pod2daemon-flexvol/',
        '/fluent/fluent-bit/',
        '/grafana/grafana/',
        '/grafana/loki/',
        '/grafana/promtail/',
        '/k8scloudprovider/openstack-cloud-controller-manager/',
        '/k8scloudprovider/cinder-csi-plugin/',
        '/kubesphere/fluent-bit/',
        '/kubesphere/fluent-operator/',
        '/nginx/',
      ],
    },
    {
      matchFileNames: [
        'config/images/images.yaml',
      ],
      postUpgradeTasks: {
        commands: [
          'install-tool golang 1.22.5',
          'go install github.com/mikefarah/yq/v4@latest',
          'bash -c "sed -i `yq \'(.images[] | select(.source == \\"{{{depName}}}\\") | key) as \\$imagePos | (.images[\\$imagePos].tags | length) as \\$tagLength | .images[\\$imagePos].tags[\\$tagLength - 1] | line\' config/images/images.yaml`\'i\\  - {{{currentValue}}}\' config/images/images.yaml"',
        ],
        executionMode: 'update',
      },
    },
  ],
}
