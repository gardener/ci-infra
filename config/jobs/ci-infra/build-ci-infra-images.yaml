postsubmits:
  gardener/ci-infra:
  - name: post-build-ci-infra-images
    cluster: gardener-prow-trusted
    branches:
    - ^master$
    annotations:
      description: Testing ci-infra image build on master branch
    decorate: true
    reporter_config:
      slack:
        channel: "gardener-prow-alerts"
    spec:
      serviceAccountName: image-builder
      containers:
      - name: image-builder
        image: ghcr.io/gardener/ci-infra/image-builder:latest
        command:
        - /image-builder
        args:
        - --log-level=info
        - --docker-config-secret=k8s-playground-docker-config
        - --registry=eu.gcr.io/sap-cloud-platform-dev1/buildapp-ci-infra
        - --cache-registry=eu.gcr.io/sap-cloud-platform-dev1/kaniko-cache
        - --target=cla-assistant
        - --target=image-builder
        - --kaniko-arg=--build-arg=GOLANG_VERSION=1.17.8
        - --add-date-sha-tag=true
        - --add-fixed-tag=latest
        # image-builder is the pod which is "scheduled" to a node. The pods created by image-builder have an affinity rule
        # which schedules them to the same node as their parent image-builder. This needs to be done, that PVCs could be mounted
        # to multiple build pods in parallel.
        # For a proper scheduling the combined resource requests of all build pods are assigned to this pod, even though it does not
        # use them. The resource requests of build pods themselves are "0"
        resources:
          requests:
            cpu: 6
            memory: 2000Mi
      # Node selector is copied to build pods
      nodeSelector:
        dedicated: high-cpu
      # Tolerations are copied to build pods
      tolerations:
      - key: "dedicated"
        operator: "Equal"
        value: "high-cpu"
        effect: "NoSchedule"
  - name: post-build-golang-test-image
    cluster: gardener-prow-trusted
    run_if_changed: 'dockerfile'
    branches:
    - ^master$
    annotations:
      description: Testing golang-test image build on master branch
    decorate: true
    reporter_config:
      slack:
        channel: "gardener-prow-alerts"
    spec:
      serviceAccountName: image-builder
      containers:
      - name: image-builder
        image: ghcr.io/gardener/ci-infra/image-builder:latest
        command:
        - /image-builder
        args:
        - --log-level=info
        - --docker-config-secret=k8s-playground-docker-config
        - --registry=eu.gcr.io/sap-cloud-platform-dev1/buildapp-ci-infra
        - --cache-registry=eu.gcr.io/sap-cloud-platform-dev1/kaniko-cache
        - --target=golang-test
        - --kaniko-arg=--build-arg=GOLANG_VERSION=1.17.8
        - --kaniko-arg=--reproducible
        - --add-fixed-tag=1.17.8
        - --add-fixed-tag=1.17
        - --add-fixed-tag=latest
        - --add-date-sha-tag=true
        # image-builder is the pod which is "scheduled" to a node. The pods created by image-builder have an affinity rule
        # which schedules them to the same node as their parent image-builder. This needs to be done, that PVCs could be mounted
        # to multiple build pods in parallel.
        # For a proper scheduling the combined resource requests of all build pods are assigned to this pod, even though it does not
        # use them. The resource requests of build pods themselves are "0"
        resources:
          requests:
            cpu: 2
            memory: 2000Mi
      # Node selector is copied to build pods
      nodeSelector:
        dedicated: high-cpu
      # Tolerations are copied to build pods
      tolerations:
      - key: "dedicated"
        operator: "Equal"
        value: "high-cpu"
        effect: "NoSchedule"
