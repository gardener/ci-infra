presubmits:
  gardener/gardener:
  - name: pull-gardener-verify-image-build
    cluster: gardener-prow-build
    always_run: true
    skip_branches:
    - release-v\d+.\d+ # don't run on release branches for now (add a job per branch later)
    annotations:
      description: Verify gardener image build on pull requests to master branch
      fork-per-release: "true"
    decorate: true
    spec:
      containers:
      - name: buildkit
        image: moby/buildkit:v0.27.1-rootless
        command:
        - /usr/local/bin/buildctl-testbuild-daemonless.sh
        args:
        - --context
        - /home/prow/go/src/github.com/gardener/gardener
        - --dockerfile
        - /home/prow/go/src/github.com/gardener/gardener
        - --build-arg
        - GOPROXY=http://athens-proxy.athens.svc.cluster.local,direct
        - --target
        - apiserver
        - --target
        - controller-manager
        - --target
        - scheduler
        - --target
        - gardenlet
        - --target
        - gardenadm
        - --target
        - admission-controller
        - --target
        - resource-manager
        - --target
        - node-agent
        - --target
        - operator
        - --target
        - gardener-extension-provider-local
        - --target
        - gardener-extension-admission-local
        readinessProbe:
          exec:
            command:
              - buildctl
              - debug
              - workers
          initialDelaySeconds: 5
          periodSeconds: 30
        livenessProbe:
          exec:
            command:
              - buildctl
              - debug
              - workers
          initialDelaySeconds: 5
          periodSeconds: 30
        securityContext:
          seccompProfile:
            type: Unconfined
          appArmorProfile:
            type: Unconfined
          runAsUser: 1000
          runAsGroup: 1000
        volumeMounts:
        - name: buildctl-testbuild-script
          mountPath: /usr/local/bin/buildctl-testbuild-daemonless.sh
          subPath: buildctl-testbuild-daemonless.sh
          readOnly: true
        - name: buildkit-config
          mountPath: /home/user/.config/buildkit
          readOnly: true
        resources:
          requests:
            cpu: 6
            memory: 7Gi
      volumes:
      - name: buildctl-testbuild-script
        configMap:
          name: buildctl-testbuild-script
          defaultMode: 0555
      - name: buildkit-config
        configMap:
          name: buildkit-config
